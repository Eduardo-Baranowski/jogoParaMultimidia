<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 1</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-color: black;
            background-size: cover;
        }

        .container {
            margin-left: 40%;
            margin-top: 20em;
            z-index: 9999;
            position: absolute;
        }

        canvas {
            position: absolute;
            z-index: -9999;
        }

        button {
            border-radius: 3px;
            width: 7em;
            height: 2.8em;
            border: solid 4px rgb(16, 52, 255);
            -webkit-box-shadow: 0px 0px 70px 12px rgba(15, 217, 39, 1);
            -moz-box-shadow: 0px 0px 70px 12px rgba(15, 217, 39, 1);
            box-shadow: 0px 0px 70px 12px rgb(16, 52, 255);
            background-color: rgb(16, 52, 255);
            color: white;
        }

        button:hover {
            border-radius: 3px;
            width: 7.4em;
            height: 3.2em;
            border: solid 4px rgb(16, 52, 255);
            box-shadow: 0px 0px 70px 12px rgb(16, 52, 255);
            background-color: rgb(16, 52, 255);
            color: white;
        }

        input {
            border-radius: 3px;
            height: 2em;
            border: solid 4px rgb(255, 15, 15);
            box-shadow: 0px 0px 70px 12px rgb(255, 15, 15);
        }

        input:hover {
            border-radius: 3px;
            height: 2.4em;
            width: 13em;
            border: solid 4px rgb(255, 15, 15);
            -webkit-box-shadow: 0px 0px 70px 12px rgba(15, 217, 39, 1);
            -moz-box-shadow: 0px 0px 70px 12px rgba(15, 217, 39, 1);
            box-shadow: 0px 0px 70px 12px rgb(255, 15, 15);
        }

        #reiniciar {
            margin-left: 75%;
            margin-top: 25em;
        }
    </style>
</head>

<body>

    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },

            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        var game
        var nick = ""
        var banana
        var copoVidro
        var garrafaAmassada
        var lataRefrigerante
        var sacola
        var maçaMordida
        var banana
        var score = 0;
        var time = -100;
        var endGame = false;
        var qtdLixo = 7
        var scoreText;
        var gameOverText;

        var handleName = function () {
            var nome = document.getElementById("nome")
            nick = nome.value
            nick == "" ? alert("Por favor digite um nick") : (null)
            localStorage.setItem(nick, null)
            nome.style.display = "none";
            document.getElementById("botao").style.display = "none"
            initGame()
        }

        function initGame() {
            game = new Phaser.Game(config)
        }

        function preload() {
            this.load.image('cascaDeBanana', 'assets/casca-de-banana.png')
            this.load.image('bolaDePapel', 'assets/bola-de-papel-png-clipart.png')
            this.load.image('copoVidro', 'assets/copoVidro.png')
            this.load.image('garrafaAmassada', 'assets/garrafaAmassada.png')
            this.load.image('lataRefrigerante', 'assets/lataRefrigerante.png')
            this.load.image('sacola', 'assets/sacola.png')
            this.load.image('macaMordida', 'assets/maçaMordida.png')
            this.load.image('lixeiraPapel', 'assets/lixeiraDePapel.png')
            this.load.image('lixeiraVidro', 'assets/lexeiraDeVidro.png')
            this.load.image('lixeiraMetal', 'assets/lixeiraDeMetal.png')
            this.load.image('lixeiraOrganico', 'assets/lixeiraDeOrganico.png')
            this.load.image('lixeirasPlastico', 'assets/lixeiraDePlastico.png')
            this.load.image('sky', 'assets/fundo.jpg');
        }

        function create() {
            //adciona o fundo do jogo
            this.add.image(400, 300, 'sky');

            // adicona as lixeira com fisíca estatica
            lixeiraPapel = this.physics.add.staticGroup()
            lixeiraVidro = this.physics.add.staticGroup()
            lixeiraMetal = this.physics.add.staticGroup()
            lixeiraPlastico = this.physics.add.staticGroup()
            lixeiraOrganico = this.physics.add.staticGroup()

            //associa a imagem do objeto
            lixeiraPapel.create(200, 110, 'lixeiraPapel').setScale(0.5).refreshBody();
            lixeiraVidro.create(300, 110, 'lixeiraVidro').setScale(0.5).refreshBody();
            lixeiraMetal.create(400, 110, 'lixeiraMetal').setScale(0.5).refreshBody();
            lixeiraOrganico.create(500, 110, 'lixeiraOrganico').setScale(0.5).refreshBody();
            lixeiraPlastico.create(620, 110, 'lixeirasPlastico').setScale(0.5).refreshBody();

            //adciona o sprite na tela, em uma posição aleatoria delimitada, para que os sprits não se choquem com as lixeira
            //fazendo com que os mesmos desapareçam
            bolaDePapel = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'bolaDePapel')
                .setScale(0.1)
                .setInteractive()

            copoVidro = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'copoVidro')
                .setScale(0.2)
                .setInteractive()

            garrafaAmassada = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'garrafaAmassada')
                .setScale(0.1)
                .setInteractive()

            lataRefrigerante = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'lataRefrigerante')
                .setScale(0.1)
                .setInteractive()

            sacola = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'sacola')
                .setScale(0.2)
                .setInteractive()

            macaMordida = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'macaMordida')
                .setScale(0.2)
                .setInteractive()
            banana = this.physics.add.sprite(
                Phaser.Math.Between(
                    config.width / 3,
                    config.width / 1.2
                ),
                Phaser.Math.Between(
                    config.height / 3,
                    config.height / 1.2
                ), 'cascaDeBanana')
                .setScale(0.2)
                .setInteractive()

            // permite com que o objeto seja arrastado na tela 
            this.input.setDraggable(banana)
            this.input.setDraggable(bolaDePapel)
            this.input.setDraggable(garrafaAmassada)
            this.input.setDraggable(macaMordida)
            this.input.setDraggable(sacola)
            this.input.setDraggable(copoVidro)
            this.input.setDraggable(lataRefrigerante)

            //permite ativar a função de arrasto ao clique e movimento do mouse
            this.input.dragTimeThreshold = 500
            this.input.on('dragstart', function (pointer, gameObject) {
                gameObject.setTint(0xff0000)
            })
            this.input.on('drag', function (pointer, gameObject, dragX, dragY) {
                gameObject.x = dragX
                gameObject.y = dragY
            })
            this.input.on('dragend', function (pointer, gameObject) {
                gameObject.clearTint()
            })

            //adciona colição entre os objetos e suas respectivas lixeiras
            this.physics.add.collider(banana, lixeiraOrganico);
            this.physics.add.collider(bolaDePapel, lixeiraPapel);
            this.physics.add.collider(garrafaAmassada, lixeiraPlastico);
            this.physics.add.collider(macaMordida, lixeiraOrganico);
            this.physics.add.collider(sacola, lixeiraPlastico);
            this.physics.add.collider(copoVidro, lixeiraVidro);
            this.physics.add.collider(lataRefrigerante, lixeiraMetal);

            //passa as informações de qual objeto está conlidindo com qual 
            this.physics.add.overlap(banana, lixeiraOrganico, collectLixo, null, this);
            this.physics.add.overlap(bolaDePapel, lixeiraPapel, collectLixo, null, this);
            this.physics.add.overlap(garrafaAmassada, lixeiraPlastico, collectLixo, null, this);
            this.physics.add.overlap(macaMordida, lixeiraOrganico, collectLixo, null, this);
            this.physics.add.overlap(sacola, lixeiraPlastico, collectLixo, null, this);
            this.physics.add.overlap(copoVidro, lixeiraVidro, collectLixo, null, this);
            this.physics.add.overlap(lataRefrigerante, lixeiraMetal, collectLixo, null, this);
            //adciona o score na tela para ve a pontação 
            scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '24px', fill: '#000' });

        }
        function update() {
            if (endGame) {
                return;
            }
            time++
        }
        function caculaPontoPorMenorTempo(time) {
            if (time > 0 && time < 200) {
                return 100
            }
            if (time > 200 && time < 300) {
                return 50
            }
            if (time > 300 && time < 400) {
                return 25
            }
            if (time > 400 && time < 500) {
                return 10;
            }
            if (time > 500 && time < 600) {
                return 5;
            }
            if (time > 600) {
                return 1
            }
        }
        function collectLixo(lixo, lixeira) {
            lixo.disableBody(true, true);
            score += 10;
            scoreText.setText('Score: ' + score);
            qtdLixo--

            localStorage.setItem(nick, score);

            if (qtdLixo == 0) {
                localStorage.setItem(nick, score + caculaPontoPorMenorTempo(time));
                gameOver = true;
                gameOverText = this.add.text(90, 170, 'Fim de jogo!', { fontSize: '80px', fill: '#8B0000', fontFamily: 'Avantgarde' });
                if (localStorage.length > 0) {
                    var localStorageArray = new Array();
                    for (i = 0; i < localStorage.length; i++) {
                        localStorageArray[i] = { key: localStorage.key(i), value: localStorage.getItem(localStorage.key(i)) }
                    }
                }
                var sortedArray = localStorageArray.sort(function (a, b) {
                    return b.value - a.value
                })
                gameOverText = this.add.text(90, 300, Object.keys(sortedArray).map(function (key, value) {
                    return sortedArray[key].key + "--------------" + sortedArray[key].value
                }), { fontSize: '40px', fill: '#008000', fontFamily: 'Avantgarde' });
                gameOverText = this.add.text(createButton());
            }


        }
        function createButton() {
            var btn = document.createElement('BUTTON');
            var lbl = document.createTextNode("Reinciar");
            btn.appendChild(lbl);
            btn.setAttribute("id", "reiniciar")
            btn.onclick = function () {
                location.reload();
            }
            document.body.appendChild(btn);
        }
    </script>
    <div class="container">
        <input type="text" maxlength="4" id="nome" placeholder="Digite seu nome" />
        <button type="button" id="botao" onclick="handleName()">Jogar</button>
    </div>

</body>

</html>
